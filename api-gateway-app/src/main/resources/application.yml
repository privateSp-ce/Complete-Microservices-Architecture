spring:
  application:
    name: api-gateway-app  # 1. Give the gateway a name
  cloud:
    gateway:
      server:
        webflux:
          routes:  # 4. Define the routing rule for product-service
            - id: product_route
              # uses lb to find services registered in EUREKA
              uri: lb://PRODUCT-SERVICE-APP
              predicates:
                - Path=/products/**
              # ❌ NOT NEEDED if your ProductController already has /products
              filters:
                - RewritePath=/products/(?<segment>.*), /$\{segment}

            # Rule 2: Order Service (Manam ippudu add cheyyalsindi)
            - id: order_route       # Ee rule ki oka peru (e.g., order_route)
              uri: lb://ORDER-SERVICE-APP   # order-service-app ye peru tho register aindi?
              predicates:
                - Path=/orders/**   # OrderController lo manam ye path create chesam?
              # ❌ NOT NEEDED if your OrderController already has /orders
              filters:
                - RewritePath=/orders/(?<segment>.*), /$\{segment}

            # ⭐ CRITICAL: Ee route OpenAPI docs kosam add cheyali
            - id: openapi-product
              uri: lb://PRODUCT-SERVICE-APP
              predicates:
                - Path=/products/v3/api-docs
              filters:
                - RewritePath=/products/v3/api-docs(?<segment>.*), /v3/api-docs$\{segment}

            - id: openapi-order
              uri: lb://ORDER-SERVICE-APP
              predicates:
                - Path=/orders/v3/api-docs
              filters:
                - RewritePath=/orders/v3/api-docs(?<segment>.*), /v3/api-docs$\{segment}

server:
  port: 9000  # 2. Set a unique port for it

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/  # 3. Tell it where the Eureka server is
  
  instance:
    prefer-ip-address: true  # Register with IP address instead of hostname

# ----------------------------------------------------
# DISTRIBUTED TRACING (ZIPKIN) CONFIGURATION
# ----------------------------------------------------
management:
  zipkin:
    tracing:
      # Mana Zipkin dashboard address
      endpoint: http://localhost:9411/api/v2/spans
  tracing:
    # Ee service nunchi vache prathi request ni trace cheyyadaniki
    enabled: true
    sampling:
      probability: 1.0 # 1.0 ante 100% of requests ni trace cheyyi ani ardam

  # ----------------------------------------------------
  # THE FIX: Add this block to "turn on" the endpoints
  # ----------------------------------------------------
  endpoints:
    web:
      exposure:
        # "*" anedi, anni management endpoints ni (Zipkin tho saha) expose chesthundi
        include: "*"

  endpoint:
    health:
      show-details: always
    prometheus:
      access: read_only

  metrics:
    tags:
      application: ${spring.application.name}  # Tag all metrics with service name
    distribution:
      percentiles-histogram:
        http.server.requests: true  # Generate histograms for request duration
  prometheus:
    metrics:
      export:
        enabled: true

# ⭐⭐⭐ MOST IMPORTANT: Ee configuration add cheyali
# ⭐⭐⭐ Springdoc configuration
# ⭐⭐⭐ Expose only those which are needed. In this way we can protect our important endpoints
springdoc:
  swagger-ui:
    urls-primary-name: API Documentation
    enabled: true
    urls:
      - name: Product Service
        url: /products/v3/api-docs
      - name: Order Service
        url: /orders/v3/api-docs

logging:
  pattern:
    level: "%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]"
